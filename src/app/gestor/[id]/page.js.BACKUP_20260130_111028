'use client'

import { useEffect, useMemo, useState } from 'react'
import { useParams, useRouter } from 'next/navigation'
import Link from 'next/link'
import { supabase } from '@/lib/supabase'
import ProtectedRoute from '@/components/ProtectedRoute'
import { useAuth } from '@/components/AuthContext'

function onlySelectedMap(map) {
  const m = map && typeof map === 'object' ? map : {}
  const selected = []
  for (const [k, v] of Object.entries(m)) {
    if (v === true) selected.push(k)
  }
  return selected
}

function groupByCategoria(list) {
  const out = { block: [], cabezote: [], otros: [] }
  for (const it of list || []) {
    const cat = (it?.categoria || '').toLowerCase()
    if (cat.includes('block')) out.block.push(it)
    else if (cat.includes('cabezote') || cat.includes('culata')) out.cabezote.push(it)
    else out.otros.push(it)
  }
  return out
}

export default function GestorDetalleOrden() {
  const params = useParams()
  const router = useRouter()
  const { role } = useAuth()

  const rawId = params?.id
  const id = Array.isArray(rawId) ? rawId[0] : rawId

  const [orden, setOrden] = useState(null)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState(null)

  const [fotosLoading, setFotosLoading] = useState(false)
  const [fotosError, setFotosError] = useState(null)
  const [fotos, setFotos] = useState([])

  useEffect(() => {
    if (!id) return

    const load = async () => {
      setLoading(true)
      setError(null)

      const { data, error } = await supabase
        .from('ordenes')
        .select('*')
        .eq('id', id)
        .single()

      if (error) {
        setError(error.message)
        setOrden(null)
      } else {
        setOrden(data)
      }
      setLoading(false)
    }

    load()
  }, [id])

  useEffect(() => {
    if (!id) return

    const loadFotos = async () => {
      setFotosLoading(true)
      setFotosError(null)

      try {
        const res = await fetch(`/api/ordenes/${id}/fotos`, { method: 'GET' })
        const json = await res.json().catch(() => null)

        if (!res.ok) {
          setFotos([])
          setFotosError(json?.error || `Error cargando fotos (${res.status})`)
          return
        }

        const list = Array.isArray(json?.fotos) ? json.fotos : []
        const ok = list.filter((x) => x?.url && !x?.error)
        setFotos(ok)
      } catch (e) {
        setFotos([])
        setFotosError(e?.message || 'Error cargando fotos')
      } finally {
        setFotosLoading(false)
      }
    }

    loadFotos()
  }, [id])

  const piezasSeleccionadas = useMemo(() => {
    return onlySelectedMap(orden?.datos_vino)
  }, [orden])

  const fotosByCat = useMemo(() => groupByCategoria(fotos), [fotos])

  if (loading) return <div className='p-6'>Cargando orden...</div>
  if (error) return <div className='p-6 text-red-600'>Error: {error}</div>
  if (!orden) return <div className='p-6'>Orden no encontrada</div>

  return (
    <ProtectedRoute requiredRole={['admin', 'tecnico']}>
      <div className='space-y-6'>
        <div className='flex justify-between items-center flex-wrap gap-3'>
          <h1 className='text-2xl font-black'>
            Orden <span className='text-red-600'>#{String(id).slice(0, 8)}</span>
          </h1>

          <div className='flex gap-2 flex-wrap'>
            <button
              onClick={() => router.back()}
              className='px-4 py-2 border rounded'
            >
              Volver
            </button>

            <Link
              href={`/ordenes/${id}/editar`}
              className='px-4 py-2 bg-red-600 text-white rounded'
            >
              Editar
            </Link>
          </div>
        </div>

        {/* Datos principales */}
        <div className='bg-white rounded-xl border p-6 grid grid-cols-1 md:grid-cols-2 gap-4'>
          <div><b>Cliente:</b> {orden.cliente || '-'}</div>
          <div><b>Mecánico:</b> {orden.mecanico_dueno || '-'}</div>
          <div><b>Cédula:</b> {orden.cedula_dueno || '-'}</div>
          <div><b>Motor:</b> {orden.motor || '-'}</div>
          <div><b>Serie:</b> {orden.serie_motor || '-'}</div>
          <div><b>Tipo:</b> {orden.tipo_motor || '-'}</div>
          <div><b>Estado:</b> {orden.estado || '-'}</div>
          <div><b>Prioridad:</b> {orden.prioridad || '-'}</div>
          <div><b>Fecha estimada:</b> {orden.fecha_estimada ? String(orden.fecha_estimada).slice(0, 10) : '-'}</div>
          {role === 'admin' ? (
            <div><b>Precio:</b> {orden.precio != null ? orden.precio : '-'}</div>
          ) : (
            <div><b>Precio:</b> (solo admin)</div>
          )}
        </div>

        {/* Recepción / checklist */}
        <div className='bg-white rounded-xl border p-6'>
          <b>Recepción (solo lo marcado)</b>

          {piezasSeleccionadas.length ? (
            <div className='mt-3 flex flex-wrap gap-2'>
              {piezasSeleccionadas.map((p) => (
                <span
                  key={p}
                  className='px-3 py-1 rounded-full text-xs font-bold bg-stone-100 text-stone-700 border'
                >
                  {p}
                </span>
              ))}
            </div>
          ) : (
            <p className='mt-2 text-stone-500 text-sm'>No se marcó ninguna pieza.</p>
          )}

          {orden.datos_vino_detalle ? (
            <div className='mt-4'>
              <div className='text-xs font-black uppercase tracking-widest text-stone-500'>
                Detalle / novedades
              </div>
              <p className='mt-2 whitespace-pre-wrap'>{orden.datos_vino_detalle}</p>
            </div>
          ) : null}
        </div>

        {/* Observaciones */}
        <div className='bg-white rounded-xl border p-6'>
          <b>Observaciones</b>
          <p className='mt-2 whitespace-pre-wrap'>{orden.observaciones || ''}</p>
        </div>

        {/* Fotos */}
        <div className='bg-white rounded-xl border p-6'>
          <div className='flex items-center justify-between gap-3 flex-wrap'>
            <b>Fotos</b>
            {fotosLoading ? (
              <span className='text-sm text-stone-500'>Cargando fotos...</span>
            ) : fotosError ? (
              <span className='text-sm text-red-600'>Error: {fotosError}</span>
            ) : (
              <span className='text-sm text-stone-500'>{fotos.length} foto(s)</span>
            )}
          </div>

          {!fotosLoading && !fotos.length ? (
            <p className='mt-3 text-stone-500 text-sm'>No hay fotos registradas en esta orden.</p>
          ) : null}

          {/* Block */}
          {fotosByCat.block.length ? (
            <div className='mt-5'>
              <div className='text-sm font-black text-stone-800 mb-2'>Block</div>
              <div className='grid grid-cols-2 md:grid-cols-4 gap-3'>
                {fotosByCat.block.map((f, idx) => (
                  <a key={idx} href={f.url} target='_blank' rel='noreferrer' className='block'>
                    <img
                      src={f.url}
                      alt='Foto block'
                      className='w-full h-40 object-cover rounded-lg border'
                      loading='lazy'
                    />
                  </a>
                ))}
              </div>
            </div>
          ) : null}

          {/* Cabezote */}
          {fotosByCat.cabezote.length ? (
            <div className='mt-6'>
              <div className='text-sm font-black text-stone-800 mb-2'>Cabezote</div>
              <div className='grid grid-cols-2 md:grid-cols-4 gap-3'>
                {fotosByCat.cabezote.map((f, idx) => (
                  <a key={idx} href={f.url} target='_blank' rel='noreferrer' className='block'>
                    <img
                      src={f.url}
                      alt='Foto cabezote'
                      className='w-full h-40 object-cover rounded-lg border'
                      loading='lazy'
                    />
                  </a>
                ))}
              </div>
            </div>
          ) : null}

          {/* Otros */}
          {fotosByCat.otros.length ? (
            <div className='mt-6'>
              <div className='text-sm font-black text-stone-800 mb-2'>Otras</div>
              <div className='grid grid-cols-2 md:grid-cols-4 gap-3'>
                {fotosByCat.otros.map((f, idx) => (
                  <a key={idx} href={f.url} target='_blank' rel='noreferrer' className='block'>
                    <img
                      src={f.url}
                      alt='Foto'
                      className='w-full h-40 object-cover rounded-lg border'
                      loading='lazy'
                    />
                  </a>
                ))}
              </div>
            </div>
          ) : null}
        </div>
      </div>
    </ProtectedRoute>
  )
}